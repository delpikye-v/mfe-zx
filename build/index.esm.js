var t=function(){return t=Object.assign||function(t){for(var e,n=1,r=arguments.length;n<r;n++)for(var o in e=arguments[n])Object.prototype.hasOwnProperty.call(e,o)&&(t[o]=e[o]);return t},t.apply(this,arguments)};function e(t,e,n,r){return new(n||(n=Promise))(function(o,a){function i(t){try{s(r.next(t))}catch(t){a(t)}}function u(t){try{s(r.throw(t))}catch(t){a(t)}}function s(t){var e;t.done?o(t.value):(e=t.value,e instanceof n?e:new n(function(t){t(e)})).then(i,u)}s((r=r.apply(t,e||[])).next())})}function n(t,e){var n,r,o,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]},i=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return i.next=u(0),i.throw=u(1),i.return=u(2),"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function u(u){return function(s){return function(u){if(n)throw new TypeError("Generator is already executing.");for(;i&&(i=0,u[0]&&(a=0)),a;)try{if(n=1,r&&(o=2&u[0]?r.return:u[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,u[1])).done)return o;switch(r=0,o&&(u=[2&u[0],o.value]),u[0]){case 0:case 1:o=u;break;case 4:return a.label++,{value:u[1],done:!1};case 5:a.label++,r=u[1],u=[0];continue;case 7:u=a.ops.pop(),a.trys.pop();continue;default:if(!(o=a.trys,(o=o.length>0&&o[o.length-1])||6!==u[0]&&2!==u[0])){a=0;continue}if(3===u[0]&&(!o||u[1]>o[0]&&u[1]<o[3])){a.label=u[1];break}if(6===u[0]&&a.label<o[1]){a.label=o[1],o=u;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(u);break}o[2]&&a.ops.pop(),a.trys.pop();continue}u=e.call(t,a)}catch(t){u=[6,t],r=0}finally{n=o=0}if(5&u[0])throw u[1];return{value:u[0]?u[1]:void 0,done:!0}}([u,s])}}}"function"==typeof SuppressedError&&SuppressedError;var r=new Set;function o(t,o){return void 0===o&&(o={}),e(this,void 0,void 0,function(){var e,i,u,s,c,l;return n(this,function(n){switch(n.label){case 0:if(e=o.timeout,i=void 0===e?15e3:e,u=o.retries,s=void 0===u?1:u,r.has(t))return[2];c=0,n.label=1;case 1:if(!(c<=s))return[3,6];n.label=2;case 2:return n.trys.push([2,4,,5]),[4,a(t,i)];case 3:return n.sent(),r.add(t),[2];case 4:if(l=n.sent(),!(c<s))throw l;return console.warn("Attempt ".concat(c+1," failed for ").concat(t,", retrying...")),[3,5];case 5:return c++,[3,1];case 6:return[2]}})})}function a(t,e){return new Promise(function(n,r){var o=document.createElement("script");o.src=t,o.async=!0;var a=setTimeout(function(){i(),r(new Error("Timeout loading ".concat(t)))},e);function i(t){void 0===t&&(t=!0),clearTimeout(a),t&&o.remove()}o.onload=function(){i(!1),n()},o.onerror=function(){i(),r(new Error("Failed to load ".concat(t)))},document.head.appendChild(o)})}var i=function(){function t(){this.map=new Map}return t.prototype.on=function(t,e){this.map.has(t)||this.map.set(t,new Set),this.map.get(t).add(e)},t.prototype.off=function(t,e){var n;null===(n=this.map.get(t))||void 0===n||n.delete(e)},t.prototype.emit=function(t,e){var n;null===(n=this.map.get(t))||void 0===n||n.forEach(function(t){return t(e)})},t}(),u={REQUEST_NAVIGATE:"ROUTER:REQUEST_NAVIGATE",NAVIGATE:"ROUTER:NAVIGATE",ROUTER_CHANGE:"ROUTER:ON_CHANGE"};var s={INTENT_DISPATCH:"intent:dispatch",INTENT_RESOLVE_START:"intent:resolve:start",INTENT_RESOLVE_END:"intent:resolve:end",INTENT_RESOLVE_ERROR:"intent:resolve:error",MFE_LOAD_START:"mfe:load:start",MFE_LOAD_END:"mfe:load:end",MFE_MOUNT_START:"mfe:mount:start",MFE_MOUNT_END:"mfe:mount:end",MFE_RELOAD_START:"mfe:reload:start",MFE_RELOAD_END:"mfe:reload:end",MFE_ERROR:"mfe:error"},c=function(){function t(t){void 0===t&&(t={});var e,n,r,o,a,s,c,l=this;this.isolate=!1,this.defaultTimeout=15e3,this.defaultRetries=1,this.cache={},this.mountMap=new Map,this.stores=null!==(e=t.stores)&&void 0!==e?e:{},this.navigate=t.navigate,this.fallback=t.fallback,this.eventBus=null!==(n=t.eventBus)&&void 0!==n?n:new i,this.isolate=null!==(r=t.isolate)&&void 0!==r&&r,this.defaultTimeout=null!==(o=t.defaultTimeout)&&void 0!==o?o:15e3,this.defaultRetries=null!==(a=t.defaultRetries)&&void 0!==a?a:1,this.navigate&&(s=this.eventBus,c=this.navigate,s.on(u.REQUEST_NAVIGATE,function(t){var e=t.path;c(e),s.emit(u.NAVIGATE,{path:e})})),this.eventBus.on(u.ROUTER_CHANGE,function(t){var e,n;null===(e=l.navigate)||void 0===e||e.call(l,null!==(n=t.path)&&void 0!==n?n:t)})}return t.prototype.load=function(t,r,a,i){return e(this,void 0,void 0,function(){var e;return n(this,function(n){switch(n.label){case 0:return this.cache[r]?[2,this.cache[r]]:[4,o(t,{timeout:null!=a?a:this.defaultTimeout,retries:null!=i?i:this.defaultRetries})];case 1:if(n.sent(),!(null==(e=window[r])?void 0:e.mount))throw new Error('Remote "'.concat(r,'" not found or invalid'));return this.cache[r]=e,[2,e]}})})},t.prototype.mountInternal=function(t,e,n,r){var o,a,i=null!==(o=null==r?void 0:r.isolate)&&void 0!==o?o:this.isolate,u=this.mountMap.get(e);u&&(u.container.innerHTML="");var s,c=e;i&&e.attachShadow&&(c=s=e.attachShadow({mode:null!==(a=null==r?void 0:r.shadowMode)&&void 0!==a?a:"open"}));var l=document.createElement("div");c.appendChild(l),this.mountMap.set(e,{container:l,shadowRoot:s});var h={name:n,stores:this.stores,eventBus:this.eventBus,host:{navigate:this.navigate}};t.mount(l,h)},t.prototype.mount=function(t,r,o,a){return e(this,void 0,void 0,function(){var e,i,u,c;return n(this,function(n){i=(e=a||{}).isolate,u=e.shadowMode,c=e.traceId;try{return this.eventBus.emit(s.MFE_MOUNT_START,{name:o,traceId:c}),this.mountInternal(t,r,o,{isolate:i,shadowMode:u}),this.eventBus.emit(s.MFE_MOUNT_END,{name:o,traceId:c}),[2,t]}catch(t){return this.eventBus.emit(s.MFE_ERROR,{name:o,traceId:c,error:t,phase:"mount"}),this.renderFallback(r,o,t),[2,null]}return[2]})})},t.prototype.reload=function(t){var r,o,a;return e(this,void 0,void 0,function(){var e,i,u,c,l,h,d,f,v,m,p,E,T;return n(this,function(n){switch(n.label){case 0:e=t.name,i=t.url,u=t.global,c=t.el,l=t.isolate,h=t.shadowMode,d=t.traceId,f=t.timeout,v=t.retries,this.eventBus.emit(s.MFE_RELOAD_START,{name:e,traceId:d});try{m=window[u],p=null!==(r=c._mountEl)&&void 0!==r?r:(null!=l?l:this.isolate)&&null!==(o=c.shadowRoot)&&void 0!==o?o:c,null===(a=null==m?void 0:m.unmount)||void 0===a||a.call(m,p)}catch(t){this.eventBus.emit(s.MFE_ERROR,{name:e,traceId:d,error:t,phase:"reload-unmount"})}delete window[u],delete this.cache[u],n.label=1;case 1:return n.trys.push([1,3,,4]),[4,this.load("".concat(i,"?t=").concat(Date.now()),u,f,v)];case 2:return E=n.sent(),this.mountInternal(E,c,e,{isolate:l,shadowMode:h}),this.eventBus.emit(s.MFE_RELOAD_END,{name:e,traceId:d}),[2,E];case 3:return T=n.sent(),this.eventBus.emit(s.MFE_ERROR,{name:e,traceId:d,error:T,phase:"reload-load|mount"}),this.renderFallback(c,e,T),[2,null];case 4:return[2]}})})},t.prototype.unmount=function(t,e,n){var r;try{var o=this.mountMap.get(e);o&&(null===(r=t.unmount)||void 0===r||r.call(t,o.container),this.mountMap.delete(e))}catch(t){this.eventBus.emit(s.MFE_ERROR,{name:n,error:t,phase:"unmount"})}},t.prototype.loadAndMount=function(t){return e(this,void 0,void 0,function(){var e,r,o,a,i,u,c,l,h,d,f,v;return n(this,function(n){switch(n.label){case 0:e=t.name,r=t.url,o=t.global,a=t.el,i=t.isolate,u=t.shadowMode,c=t.traceId,l=t.timeout,h=t.retries,d=t.forceReload,n.label=1;case 1:return n.trys.push([1,3,,4]),this.eventBus.emit(s.MFE_LOAD_START,{name:e,traceId:c}),[4,this.load(d?"".concat(r,"?t=").concat(Date.now()):r,o,l,h)];case 2:return f=n.sent(),this.eventBus.emit(s.MFE_LOAD_END,{name:e,traceId:c}),this.eventBus.emit(s.MFE_MOUNT_START,{name:e,traceId:c}),this.mountInternal(f,a,e,{isolate:i,shadowMode:u}),this.eventBus.emit(s.MFE_MOUNT_END,{name:e,traceId:c}),[2,f];case 3:return v=n.sent(),this.eventBus.emit(s.MFE_ERROR,{name:e,traceId:c,error:v,phase:"load|mount"}),this.renderFallback(a,e,v),[2,null];case 4:return[2]}})})},t.prototype.renderFallback=function(t,e,n){t.innerHTML="";var r=document.createElement("div");t.appendChild(r);var o={name:e,stores:this.stores,eventBus:this.eventBus,host:{navigate:this.navigate}};this.fallback?this.fallback(r,e,n,o):r.innerHTML='<div style="color:red">Failed to load '.concat(e,"</div>")},t.prototype.getEventBus=function(){return this.eventBus},t}(),l=function(){function t(){this.remotes=new Map}return t.prototype.register=function(t){if(this.remotes.has(t.name))throw new Error("Duplicate microFE name: ".concat(t.name));this.remotes.set(t.name,t)},t.prototype.get=function(t){return this.remotes.get(t)},t.prototype.getAll=function(){return function(t,e,n){if(n||2===arguments.length)for(var r,o=0,a=e.length;o<a;o++)!r&&o in e||(r||(r=Array.prototype.slice.call(e,0,o)),r[o]=e[o]);return t.concat(r||Array.prototype.slice.call(e))}([],this.remotes.values(),!0)},t}();function h(){return Array.from({length:16},function(){return Math.floor(16*Math.random()).toString(16)}).join("")}function d(e,n){var r=e.dispatch.bind(e);e.dispatch=function(e,o){var a,i=null!==(a=null==o?void 0:o.__traceId)&&void 0!==a?a:h(),u=performance.now();return n.emit(s.INTENT_DISPATCH,{intent:e,traceId:i,payload:o,time:u}),r(e,t(t({},o),{__traceId:i}))}}function f(){var t=new Map;return{dispatch:function(r,o){return e(this,void 0,void 0,function(){var e,a,i;return n(this,function(n){switch(n.label){case 0:if(!(e=t.get(r)))return[2];a=0,i=Array.from(e),n.label=1;case 1:return a<i.length?[4,(0,i[a])(o)]:[3,4];case 2:n.sent(),n.label=3;case 3:return a++,[3,1];case 4:return[2]}})})},on:function(e,n){t.has(e)||t.set(e,new Set),t.get(e).add(n)}}}var v=function(){function t(t,e,n){this.intentEngine=t,this.host=e,this.map=n}return t.prototype.bind=function(){for(var t=this,r=function(r){o.intentEngine.on(r,function(o){return e(t,void 0,void 0,function(){var t,e,a,i,u,c,l,d,f;return n(this,function(n){switch(n.label){case 0:t=null!==(f=null==o?void 0:o.__traceId)&&void 0!==f?f:h(),e=this.map[r],a=Array.isArray(e)?e.flat(1/0):[e],(i=this.host.getEventBus()).emit(s.INTENT_RESOLVE_START,{intent:r,traceId:t,count:a.length}),n.label=1;case 1:n.trys.push([1,6,,7]),u=0,c=a,n.label=2;case 2:return u<c.length?(l=c[u],[4,this.host.loadAndMount({name:l.mfe,url:l.url,global:l.global,el:l.target(),isolate:l.isolate,traceId:t})]):[3,5];case 3:n.sent(),n.label=4;case 4:return u++,[3,2];case 5:return i.emit(s.INTENT_RESOLVE_END,{intent:r,traceId:t}),[3,7];case 6:return d=n.sent(),i.emit(s.INTENT_RESOLVE_ERROR,{intent:r,traceId:t,error:d}),[3,7];case 7:return[2]}})})})},o=this,a=0,i=Object.keys(this.map);a<i.length;a++){r(i[a])}},t}();function m(t,e,n){var r=new v(t,e,n);return r.bind(),r}var p=function(){function t(t){this.eventBus=t}return t.prototype.log=function(){var t=this;Object.values(s).forEach(function(e){t.eventBus.on(e,function(t){console.log("[".concat(e,"]"),t)})})},t.prototype.performance=function(){this.eventBus.on(s.INTENT_DISPATCH,function(t){performance.mark("intent:".concat(t.traceId,":start"))}),this.eventBus.on(s.INTENT_RESOLVE_END,function(t){performance.mark("intent:".concat(t.traceId,":end")),performance.measure("intent:".concat(t.intent),"intent:".concat(t.traceId,":start"),"intent:".concat(t.traceId,":end"))})},t}();function E(t){var e=t.eventBus,n=t.name;return{go:function(t){e.emit(u.REQUEST_NAVIGATE,{from:n,path:t})},onChange:function(t){return e.on(u.NAVIGATE,function(e){t(e.path)})},emitRouteChange:function(t){e.emit(u.ROUTER_CHANGE,{from:n,path:t})},onRouteChange:function(t){return e.on(u.ROUTER_CHANGE,function(e){e.from!==n&&t(e.path)})}}}function T(e){var n=e,r=new Set;return{getState:function(){return n},setState:function(e){n=t(t({},n),e),r.forEach(function(t){return t(n)})},subscribe:function(t,e){return void 0===e&&(e=!0),r.add(t),e&&t(n),function(){return r.delete(t)}}}}export{i as EventBus,v as IntentResolver,c as MFEHost,u as ROUTER_EVENTS,s as RUNTIME_EVENTS,l as RemoteRegistry,p as RuntimeObserver,d as bridgeIntentEngine,f as createIntentEngine,m as createIntentResolver,E as createSharedRouter,T as createSharedStore};

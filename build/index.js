!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).MFERuntimeZ={})}(this,function(t){"use strict";var e=function(){return e=Object.assign||function(t){for(var e,n=1,r=arguments.length;n<r;n++)for(var o in e=arguments[n])Object.prototype.hasOwnProperty.call(e,o)&&(t[o]=e[o]);return t},e.apply(this,arguments)};function n(t,e,n,r){return new(n||(n=Promise))(function(o,a){function i(t){try{s(r.next(t))}catch(t){a(t)}}function u(t){try{s(r.throw(t))}catch(t){a(t)}}function s(t){var e;t.done?o(t.value):(e=t.value,e instanceof n?e:new n(function(t){t(e)})).then(i,u)}s((r=r.apply(t,e||[])).next())})}function r(t,e){var n,r,o,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]},i=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return i.next=u(0),i.throw=u(1),i.return=u(2),"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function u(u){return function(s){return function(u){if(n)throw new TypeError("Generator is already executing.");for(;i&&(i=0,u[0]&&(a=0)),a;)try{if(n=1,r&&(o=2&u[0]?r.return:u[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,u[1])).done)return o;switch(r=0,o&&(u=[2&u[0],o.value]),u[0]){case 0:case 1:o=u;break;case 4:return a.label++,{value:u[1],done:!1};case 5:a.label++,r=u[1],u=[0];continue;case 7:u=a.ops.pop(),a.trys.pop();continue;default:if(!(o=a.trys,(o=o.length>0&&o[o.length-1])||6!==u[0]&&2!==u[0])){a=0;continue}if(3===u[0]&&(!o||u[1]>o[0]&&u[1]<o[3])){a.label=u[1];break}if(6===u[0]&&a.label<o[1]){a.label=o[1],o=u;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(u);break}o[2]&&a.ops.pop(),a.trys.pop();continue}u=e.call(t,a)}catch(t){u=[6,t],r=0}finally{n=o=0}if(5&u[0])throw u[1];return{value:u[0]?u[1]:void 0,done:!0}}([u,s])}}}"function"==typeof SuppressedError&&SuppressedError;var o=new Set;function a(t,e){return void 0===e&&(e={}),n(this,void 0,void 0,function(){var n,a,u,s,c,l;return r(this,function(r){switch(r.label){case 0:if(n=e.timeout,a=void 0===n?15e3:n,u=e.retries,s=void 0===u?1:u,o.has(t))return[2];c=0,r.label=1;case 1:if(!(c<=s))return[3,6];r.label=2;case 2:return r.trys.push([2,4,,5]),[4,i(t,a)];case 3:return r.sent(),o.add(t),[2];case 4:if(l=r.sent(),!(c<s))throw l;return console.warn("Attempt ".concat(c+1," failed for ").concat(t,", retrying...")),[3,5];case 5:return c++,[3,1];case 6:return[2]}})})}function i(t,e){return new Promise(function(n,r){var o=document.createElement("script");o.src=t,o.async=!0;var a=setTimeout(function(){i(),r(new Error("Timeout loading ".concat(t)))},e);function i(t){void 0===t&&(t=!0),clearTimeout(a),t&&o.remove()}o.onload=function(){i(!1),n()},o.onerror=function(){i(),r(new Error("Failed to load ".concat(t)))},document.head.appendChild(o)})}var u=function(){function t(){this.map=new Map}return t.prototype.on=function(t,e){this.map.has(t)||this.map.set(t,new Set),this.map.get(t).add(e)},t.prototype.off=function(t,e){var n;null===(n=this.map.get(t))||void 0===n||n.delete(e)},t.prototype.emit=function(t,e){var n;null===(n=this.map.get(t))||void 0===n||n.forEach(function(t){return t(e)})},t}(),s={REQUEST_NAVIGATE:"ROUTER:REQUEST_NAVIGATE",NAVIGATE:"ROUTER:NAVIGATE",ROUTER_CHANGE:"ROUTER:ON_CHANGE"};var c={INTENT_DISPATCH:"intent:dispatch",INTENT_RESOLVE_START:"intent:resolve:start",INTENT_RESOLVE_END:"intent:resolve:end",INTENT_RESOLVE_ERROR:"intent:resolve:error",MFE_LOAD_START:"mfe:load:start",MFE_LOAD_END:"mfe:load:end",MFE_MOUNT_START:"mfe:mount:start",MFE_MOUNT_END:"mfe:mount:end",MFE_RELOAD_START:"mfe:reload:start",MFE_RELOAD_END:"mfe:reload:end",MFE_ERROR:"mfe:error"},l=function(){function t(t){void 0===t&&(t={});var e,n,r,o,a,i,c,l=this;this.isolate=!1,this.defaultTimeout=15e3,this.defaultRetries=1,this.cache={},this.mountMap=new Map,this.stores=null!==(e=t.stores)&&void 0!==e?e:{},this.navigate=t.navigate,this.fallback=t.fallback,this.eventBus=null!==(n=t.eventBus)&&void 0!==n?n:new u,this.isolate=null!==(r=t.isolate)&&void 0!==r&&r,this.defaultTimeout=null!==(o=t.defaultTimeout)&&void 0!==o?o:15e3,this.defaultRetries=null!==(a=t.defaultRetries)&&void 0!==a?a:1,this.navigate&&(i=this.eventBus,c=this.navigate,i.on(s.REQUEST_NAVIGATE,function(t){var e=t.path;c(e),i.emit(s.NAVIGATE,{path:e})})),this.eventBus.on(s.ROUTER_CHANGE,function(t){var e,n;null===(e=l.navigate)||void 0===e||e.call(l,null!==(n=t.path)&&void 0!==n?n:t)})}return t.prototype.load=function(t,e,o,i){return n(this,void 0,void 0,function(){var n;return r(this,function(r){switch(r.label){case 0:return this.cache[e]?[2,this.cache[e]]:[4,a(t,{timeout:null!=o?o:this.defaultTimeout,retries:null!=i?i:this.defaultRetries})];case 1:if(r.sent(),!(null==(n=window[e])?void 0:n.mount))throw new Error('Remote "'.concat(e,'" not found or invalid'));return this.cache[e]=n,[2,n]}})})},t.prototype.mountInternal=function(t,e,n,r){var o,a,i=null!==(o=null==r?void 0:r.isolate)&&void 0!==o?o:this.isolate,u=this.mountMap.get(e);u&&(u.container.innerHTML="");var s,c=e;i&&e.attachShadow&&(c=s=e.attachShadow({mode:null!==(a=null==r?void 0:r.shadowMode)&&void 0!==a?a:"open"}));var l=document.createElement("div");c.appendChild(l),this.mountMap.set(e,{container:l,shadowRoot:s});var d={name:n,stores:this.stores,eventBus:this.eventBus,host:{navigate:this.navigate}};t.mount(l,d)},t.prototype.mount=function(t,e,o,a){return n(this,void 0,void 0,function(){var n,i,u,s;return r(this,function(r){i=(n=a||{}).isolate,u=n.shadowMode,s=n.traceId;try{return this.eventBus.emit(c.MFE_MOUNT_START,{name:o,traceId:s}),this.mountInternal(t,e,o,{isolate:i,shadowMode:u}),this.eventBus.emit(c.MFE_MOUNT_END,{name:o,traceId:s}),[2,t]}catch(t){return this.eventBus.emit(c.MFE_ERROR,{name:o,traceId:s,error:t,phase:"mount"}),this.renderFallback(e,o,t),[2,null]}return[2]})})},t.prototype.reload=function(t){var e,o,a;return n(this,void 0,void 0,function(){var n,i,u,s,l,d,h,f,v,m,p,E,T;return r(this,function(r){switch(r.label){case 0:n=t.name,i=t.url,u=t.global,s=t.el,l=t.isolate,d=t.shadowMode,h=t.traceId,f=t.timeout,v=t.retries,this.eventBus.emit(c.MFE_RELOAD_START,{name:n,traceId:h});try{m=window[u],p=null!==(e=s._mountEl)&&void 0!==e?e:(null!=l?l:this.isolate)&&null!==(o=s.shadowRoot)&&void 0!==o?o:s,null===(a=null==m?void 0:m.unmount)||void 0===a||a.call(m,p)}catch(t){this.eventBus.emit(c.MFE_ERROR,{name:n,traceId:h,error:t,phase:"reload-unmount"})}delete window[u],delete this.cache[u],r.label=1;case 1:return r.trys.push([1,3,,4]),[4,this.load("".concat(i,"?t=").concat(Date.now()),u,f,v)];case 2:return E=r.sent(),this.mountInternal(E,s,n,{isolate:l,shadowMode:d}),this.eventBus.emit(c.MFE_RELOAD_END,{name:n,traceId:h}),[2,E];case 3:return T=r.sent(),this.eventBus.emit(c.MFE_ERROR,{name:n,traceId:h,error:T,phase:"reload-load|mount"}),this.renderFallback(s,n,T),[2,null];case 4:return[2]}})})},t.prototype.unmount=function(t,e,n){var r;try{var o=this.mountMap.get(e);o&&(null===(r=t.unmount)||void 0===r||r.call(t,o.container),this.mountMap.delete(e))}catch(t){this.eventBus.emit(c.MFE_ERROR,{name:n,error:t,phase:"unmount"})}},t.prototype.loadAndMount=function(t){return n(this,void 0,void 0,function(){var e,n,o,a,i,u,s,l,d,h,f,v;return r(this,function(r){switch(r.label){case 0:e=t.name,n=t.url,o=t.global,a=t.el,i=t.isolate,u=t.shadowMode,s=t.traceId,l=t.timeout,d=t.retries,h=t.forceReload,r.label=1;case 1:return r.trys.push([1,3,,4]),this.eventBus.emit(c.MFE_LOAD_START,{name:e,traceId:s}),[4,this.load(h?"".concat(n,"?t=").concat(Date.now()):n,o,l,d)];case 2:return f=r.sent(),this.eventBus.emit(c.MFE_LOAD_END,{name:e,traceId:s}),this.eventBus.emit(c.MFE_MOUNT_START,{name:e,traceId:s}),this.mountInternal(f,a,e,{isolate:i,shadowMode:u}),this.eventBus.emit(c.MFE_MOUNT_END,{name:e,traceId:s}),[2,f];case 3:return v=r.sent(),this.eventBus.emit(c.MFE_ERROR,{name:e,traceId:s,error:v,phase:"load|mount"}),this.renderFallback(a,e,v),[2,null];case 4:return[2]}})})},t.prototype.renderFallback=function(t,e,n){t.innerHTML="";var r=document.createElement("div");t.appendChild(r);var o={name:e,stores:this.stores,eventBus:this.eventBus,host:{navigate:this.navigate}};this.fallback?this.fallback(r,e,n,o):r.innerHTML='<div style="color:red">Failed to load '.concat(e,"</div>")},t.prototype.getEventBus=function(){return this.eventBus},t}(),d=function(){function t(){this.remotes=new Map}return t.prototype.register=function(t){if(this.remotes.has(t.name))throw new Error("Duplicate microFE name: ".concat(t.name));this.remotes.set(t.name,t)},t.prototype.get=function(t){return this.remotes.get(t)},t.prototype.getAll=function(){return function(t,e,n){if(n||2===arguments.length)for(var r,o=0,a=e.length;o<a;o++)!r&&o in e||(r||(r=Array.prototype.slice.call(e,0,o)),r[o]=e[o]);return t.concat(r||Array.prototype.slice.call(e))}([],this.remotes.values(),!0)},t}();function h(){return Array.from({length:16},function(){return Math.floor(16*Math.random()).toString(16)}).join("")}var f=function(){function t(t,e,n){this.intentEngine=t,this.host=e,this.map=n}return t.prototype.bind=function(){for(var t=this,e=function(e){o.intentEngine.on(e,function(o){return n(t,void 0,void 0,function(){var t,n,a,i,u,s,l,d,f;return r(this,function(r){switch(r.label){case 0:t=null!==(f=null==o?void 0:o.__traceId)&&void 0!==f?f:h(),n=this.map[e],a=Array.isArray(n)?n.flat(1/0):[n],(i=this.host.getEventBus()).emit(c.INTENT_RESOLVE_START,{intent:e,traceId:t,count:a.length}),r.label=1;case 1:r.trys.push([1,6,,7]),u=0,s=a,r.label=2;case 2:return u<s.length?(l=s[u],[4,this.host.loadAndMount({name:l.mfe,url:l.url,global:l.global,el:l.target(),isolate:l.isolate,traceId:t})]):[3,5];case 3:r.sent(),r.label=4;case 4:return u++,[3,2];case 5:return i.emit(c.INTENT_RESOLVE_END,{intent:e,traceId:t}),[3,7];case 6:return d=r.sent(),i.emit(c.INTENT_RESOLVE_ERROR,{intent:e,traceId:t,error:d}),[3,7];case 7:return[2]}})})})},o=this,a=0,i=Object.keys(this.map);a<i.length;a++){e(i[a])}},t}();var v=function(){function t(t){this.eventBus=t}return t.prototype.log=function(){var t=this;Object.values(c).forEach(function(e){t.eventBus.on(e,function(t){console.log("[".concat(e,"]"),t)})})},t.prototype.performance=function(){this.eventBus.on(c.INTENT_DISPATCH,function(t){performance.mark("intent:".concat(t.traceId,":start"))}),this.eventBus.on(c.INTENT_RESOLVE_END,function(t){performance.mark("intent:".concat(t.traceId,":end")),performance.measure("intent:".concat(t.intent),"intent:".concat(t.traceId,":start"),"intent:".concat(t.traceId,":end"))})},t}();t.EventBus=u,t.IntentResolver=f,t.MFEHost=l,t.ROUTER_EVENTS=s,t.RUNTIME_EVENTS=c,t.RemoteRegistry=d,t.RuntimeObserver=v,t.bridgeIntentEngine=function(t,n){var r=t.dispatch.bind(t);t.dispatch=function(t,o){var a,i=null!==(a=null==o?void 0:o.__traceId)&&void 0!==a?a:h(),u=performance.now();return n.emit(c.INTENT_DISPATCH,{intent:t,traceId:i,payload:o,time:u}),r(t,e(e({},o),{__traceId:i}))}},t.createIntentEngine=function(){var t=new Map;return{dispatch:function(e,o){return n(this,void 0,void 0,function(){var n,a,i;return r(this,function(r){switch(r.label){case 0:if(!(n=t.get(e)))return[2];a=0,i=Array.from(n),r.label=1;case 1:return a<i.length?[4,(0,i[a])(o)]:[3,4];case 2:r.sent(),r.label=3;case 3:return a++,[3,1];case 4:return[2]}})})},on:function(e,n){t.has(e)||t.set(e,new Set),t.get(e).add(n)}}},t.createIntentResolver=function(t,e,n){var r=new f(t,e,n);return r.bind(),r},t.createSharedRouter=function(t){var e=t.eventBus,n=t.name;return{go:function(t){e.emit(s.REQUEST_NAVIGATE,{from:n,path:t})},onChange:function(t){return e.on(s.NAVIGATE,function(e){t(e.path)})},emitRouteChange:function(t){e.emit(s.ROUTER_CHANGE,{from:n,path:t})},onRouteChange:function(t){return e.on(s.ROUTER_CHANGE,function(e){e.from!==n&&t(e.path)})}}},t.createSharedStore=function(t){var n=t,r=new Set;return{getState:function(){return n},setState:function(t){n=e(e({},n),t),r.forEach(function(t){return t(n)})},subscribe:function(t,e){return void 0===e&&(e=!0),r.add(t),e&&t(n),function(){return r.delete(t)}}}},Object.defineProperty(t,"__esModule",{value:!0})});
